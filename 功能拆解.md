# AI 模拟面试项目 - 功能拆解与开发清单

本文档根据《初版大纲》和《架构》文档，将整个项目拆解为可执行的、循序渐- 进的开发步骤。

---

### 阶段 0: 项目设置与基础架构 (遵循 `架构.md`)

- [x] 后端项目初始化 (Node.js + Fastify)。
- [x] 数据库设置 (PostgreSQL连接配置)。
- [x] 定义并迁移所有核心表 (`Users`, `Resumes`, `InterviewSessions`, `InterviewMessages`, `PromptTemplates`, `SystemLogs`) 的数据库 Schema。
- [x] **(新)** 设置环境变量管理 (`.env` 文件)，用于安全地存储 `GOOGLE_API_KEY`, `OPENAI_API_KEY`, `OLLAMA_BASE_URL` 等不同服务商的凭证。
- [x] **(新增)** 实现 JWT 身份认证中间件，为所有 `/api/v1` 路由添加身份验证。
- [x] 前端项目初始化 (React + Vite)。
- [x] 为前端和后端建立清晰的模块化项目结构。
- [x] 在 `PromptTemplates` 表中手动插入所有 P- 系列 Prompt 的初始版本 (`P-CORP-SUMMARIZE`, `P-CONTEXT-CLARIFY`, `P-QUESTION-GENERATE`, `P-FINAL-REPORT`)。
- [x] **(新增)** 配置 Redis 连接，用于 SSE 实时通信和缓存。

---

### 阶段 1: 准备阶段 - 信息输入 (遵循 `大纲1.0`)

- **前端 (`InterviewSetupForm.js `):**
    - [x] 创建 `InterviewSetupForm.js ` 组件。
    - [x] 实现表单字段：目标岗位、简历文件上传、职位描述 (JD)、公司名称。
    - [x] 实现对 `.pdf`, `.md`, `.png`, `.jpg` 格式的文件处理逻辑，能在客户端解析或准备上传。
    - [x] 当点击"开始模拟面试"时，封装表单数据并准备 API 调用。
- **后端:**
    - [x] 创建 `POST /api/v1/interview/start` API 端点。
    - [x] 实现处理文件上传 (multipart/form-data) 的逻辑。
    - [x] **(新功能) 公司背景研究:** 如果提供了 `company_name`，则调用 `Google Search` 工具获取公司信息。
    - [x] **LLM 调用 #1 (`P-CORP-SUMMARIZE`):**
        - [x] 实现从 `PromptTemplates` 表加载公司情境总结 Prompt 的逻辑。
        - [x] 实现调用 LLM 并传入搜索结果，以获得结构化的公司摘要 JSON。
    - [x] **会话创建:**
        - [x] 生成唯一的 `session_id`。
        - [x] 将所有输入（简历文本/文件信息、JD、公司摘要）存储到 `InterviewSessions` 表中。
    - [x] 向前端返回 `session_id` 和下一阶段所需的数据（例如，角色确认文本）。

---

### 阶段 2: 配置阶段 - 确认与设置 (遵循 `大纲1.0`)

- **后端:**
    - [x] **LLM 调用 #2 (`P-CONTEXT-CLARIFY`):**
        - [x] 实现从 `PromptTemplates` 表加载角色验证 Prompt 的逻辑。
        - [x] 当 JD 未提供时，在阶段 1 之后内部触发此 LLM 调用。
        - [x] LLM 分析简历、岗位和公司情境，生成一个澄清性问题。
- **前端 (`RoleVerificationModal.js `):**
    - [x] 创建 `RoleVerificationModal.js ` 组件或类似视图。
    - [x] 显示从后端收到的澄清性问题。
    - [x] 提供"确认"和"修正"按钮。
    - [x] 如果用户选择"修正"，提供输入框并实现调用修正 API 的逻辑。
- **后端 (配置):**
    - [x] 创建 `POST /api/v1/interview/configure` API 端点以处理角色修正。
- **前端 (`SettingsForm.js `):**
    - [x] **(新)** 在面试设置 UI 中，添加用于选择"AI 服务商" (Google, OpenAI, Ollama) 和"模型"的下拉菜单或联动输入框。
- **后端 (最终确认):**
    - [x] 创建 `POST /api/v1/interview/start_session` API 端点。
    - [x] **(新)** 确保此端点能接收并验证 `provider` 和 `model` 字段。
    - [x] **(新)** 将用户选择的 `provider` 和 `model` 保存到 `InterviewSessions` 数据库表中，并将该会话状态更新为 `IN_PROGRESS`。
    - [x] 触发生成第一个面试问题的内部逻辑。

---

### 阶段 3: 执行阶段 - 模拟面试 (遵循 `大纲1.0`)

- **后端:**
    - [x] **LLM 调用 #3 (`P-QUESTION-GENERATE`):**
        - [x] **(新)** 实现 `LLM Gateway` 的核心路由逻辑。根据会话中存储的 `provider` 字段，将请求动态分发到对应的 `GoogleAdapter`, `OpenAIAdapter`, 或 `OllamaAdapter`。
        - [x] 实现从 `PromptTemplates` 表加载动态问题生成 Prompt 的逻辑。
        - [x] 实现决策树逻辑：对质量不高的回答进行追问，或提出一个新问题。
        - [x] 确保新问题的主题不与聊天历史中的问题重复。
    - [x] 创建 `POST /api/v1/interview/submit_answer` API 端点。
    - [x] 将用户的回答保存到 `InterviewMessages` 表中。
    - [x] 检查是否达到面试问题的数量上限。
    - [x] 如果面试未结束，再次触发 LLM 调用 #3 以获取下一个问题。
    - [x] 如果面试已结束，触发阶段 4 的评估逻辑。
- **前端 (`ChatInterface.js `):**
    - [x] 创建 `ChatInterface.js ` 聊天界面组件。
    - [x] 显示 AI 提出的问题。
    - [x] 实现用户输入答案的表单。
    - [x] 提交答案时，调用 `submit_answer` API 并显示"AI 思考中..."的加载状态。
    - [x] 显示 API 返回的新问题。
- **(高级) 实时通信重构 (遵循 `架构.md`)**
    - [x] **后端:** 实现一个 SSE (Server-Sent Events) 端点，用于主动向客户端推送新问题。
    - [x] **前端:** 实现 SSE 客户端逻辑，以监听和接收来自服务器的新问题事件。

---

### 阶段 4: 评估阶段 - 反馈与总结 (遵循 `大纲1.0`)

- **后端:**
    - [x] **LLM 调用 #4 (`P-FINAL-REPORT`):**
        - [x] 实现从 `PromptTemplates` 表加载最终报告生成 Prompt 的逻辑。
        - [x] 收集当前会话的所有数据（简历、JD、完整的 Q&A 历史）。
        - [x] 调用 LLM 生成结构化的 JSON 评估报告。
    - [x] 创建 `GET /api/v1/interview/report?session_id=...` API 端点。
    - [x] 返回生成的 JSON 报告。
- **前端 (`FinalReport.js `):**
    - [x] 创建 `FinalReport.js ` 报告展示组件。
    - [x] 当面试结束后，显示"评估中..."的状态。
    - [x] 轮询 `/report` 端点以获取最终的 JSON 报告。
    - [x] 解析 JSON 数据，并以用户友好的方式（例如：使用图表展示评分，使用折叠面板展示逐题分析）进行渲染。

---

### 附加功能与优化 (遵循 `架构.md`)

- **用户与记忆系统:**
    - [ ] 实现用户认证系统（例如，简单的邮箱/密码登录）。
    - [ ] 允许用户保存和管理多份简历 (`Resumes` 表)。
    - [ ] 将面试会话 (`InterviewSessions`) 与用户关联起来。
- **Prompt 管理:**
    - [ ] (可选) 构建一个简单的内部管理界面，用于查看和编辑 `PromptTemplates` 表中的提示词。
- **部署与运维:**
    - [ ] 为所有 API 和 LLM 调用实现结构化日志记录。
    - [ ] 设置对 API 延迟和错误率的基础监控。
    - [ ] **(新增)** 在 LLM Gateway 中实现针对 5xx 错误的指数退避重试（Retry）逻辑。
    - [ ] **(新增)** 为 P-CORP-SUMMARIZE 的 Google Search 结果添加 Redis 缓存（缓存期 24 小时）。
    - [ ] **(新增)** 实现简历 OCR 提取服务，支持图片文件的文本提取。
    - [ ] **(新增)** 添加多模态 LLM 输入适配器，支持 Gemini Pro Vision 和 GPT-4o 的图片输入。
    - [ ] **(新增)** 实现异常处理和失败路径的用户提示机制。
    - [ ] **(新增)** 添加会话超时和错误恢复机制。
